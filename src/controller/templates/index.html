{% extends "base.html" %}

{% block content %}
<div class="dashboard">
    <div class="card">
        <h2>Module List</h2>
        <button onclick="listModules()">List Modules</button>
        <div id="module-list">
            <!-- Modules will be listed here -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // WebSocket connection
    const ws = new WebSocket(`ws://${window.location.host}/ws`);
    
    // Calls list_modules API endpoint, clears existing list and populates with new modules
    function listModules() {
        fetch('/api/list_modules') // Fetch response from the endpoint
            .then(response => response.json()) // Parse response as JSON
            .then(data => { // With response data...
                const moduleList = document.getElementById('module-list'); // Get the module list element
                moduleList.innerHTML = ''; // Clear existing list
            
                // If no modules are found, alert the user and return
                if (data.modules.length === 0) {
                    alert('No modules found!');
                    moduleList.innerHTML = '<p>No modules available</p>';
                    return;
                }
                
                data.modules.forEach(module => { // For each module in the response...
                    const moduleDiv = document.createElement('div'); // Create a new div element
                    moduleDiv.className = 'module-item'; // Add a class to the div
                    moduleDiv.innerHTML = `
                        <p>ID: ${module.id}</p>
                        <p>Type: ${module.type}</p>
                        <p>IP: ${module.ip}</p>
                    `;
                    moduleList.appendChild(moduleDiv); // Add the div to the module list
                });
            })
            .catch(error => { // If there's an error...
                console.error('Error:', error); // Log the error
                document.getElementById('module-list').innerHTML = 'Error loading modules'; // Update the module list with an error message
            });
    }

    function updateModuleList() {
        fetch('/api/list_modules')
            .then(response => response.json())
            .then(data => {
                const moduleList = document.getElementById('module-list');
                moduleList.innerHTML = '';
                
                if (data.modules.length === 0) {
                    moduleList.innerHTML = '<p>No modules found</p>';
                    return;
                }
                
                data.modules.forEach(module => {
                    const moduleDiv = document.createElement('div');
                    moduleDiv.className = 'module-item';
                    moduleDiv.innerHTML = `
                        <p>ID: ${module.id}</p>
                        <p>Type: ${module.type}</p>
                        <p>IP: ${module.ip}</p>
                    `;
                    moduleList.appendChild(moduleDiv);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('module-list').innerHTML = 'Error loading modules';
            });
    }

    // Update immediately when page loads
    updateModuleList();

    // Then update every 5 seconds
    setInterval(updateModuleList, 5000);
</script>
{% endblock %} 