<!DOCTYPE html>
<html>
<head>
    <title>Habitat Controller</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" type="image/x-icon" href="/static/uofe_logo.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script> <!--Import socketio, used for websocket communication i.e. updates pushed from controller-->
    <script src="{{ url_for('static', filename='js/header.js') }}"></script> <!--Import header.js, used for the header of the page-->
    <script src="{{ url_for('static', filename='js/module-item.js') }}"></script> <!--Import module-item.js, used for the module list-->
</head>
<body>
    <main-header></main-header>
    
    <div class="dashboard-container">
        <div class="dashboard-card">
            <div id="dashboard-overview">
                <h2>Dashboard Overview</h2>
                <div id="dashboard-overview-content">
                    <p>Modules: <span id="number-of-modules">0</span></p>
                    <p>Camera modules: <span id="number-of-camera-modules">0</span></p>
                    <p>TTL modules: <span id="number-of-ttl-modules">0</span></p>
                </div>
            </div>
        </div>
        <div class="dashboard-card">
            <div id="module-list">
                <h2>Discovered Modules</h2>
                <div id="modules"></div>
            </div>
        </div>
        <div class="dashboard-card">
            <div id="quick-commands">
                <h2>Quick Commands</h2>
                <div id="quick-commands-content">
                    <!-- Command buttons will be generated here -->
                </div>
            </div>
        </div>
        <div class="dashboard-card">
            <div id="module-status">
                <h2>Module Status</h2>
                <div id="status-content"></div>
            </div>
        </div>
    </div>

    <!-- Module Selection Dialog -->
    <div id="module-selection-dialog" class="dialog" style="display: none;">
        <div class="dialog-content">
            <h3>Select Module</h3>
            <div class="dialog-options">
                <button class="dialog-option" data-module="all">All Modules</button>
                <div id="module-options"></div>
            </div>
            <button class="dialog-close">Cancel</button>
        </div>
    </div>

    <script>
        // Command configuration
        const commands = {
            get_status: {
                label: 'Get Status',
                type: 'get_status',
                description: 'Get the current status of selected modules'
            },
            start_recording: {
                label: 'Start Recording',
                type: 'start_recording',
                description: 'Start recording on selected modules'
            },
            stop_recording: {
                label: 'Stop Recording',
                type: 'stop_recording',
                description: 'Stop recording on selected modules'
            },
            list_recordings: {
                label: 'List Recordings',
                type: 'list_recordings',
                description: 'List available recordings on selected modules'
            },
            export_recordings: {
                label: 'Export Recordings',
                type: 'export_recordings',
                description: 'Export recordings from selected modules'
            }
        };

        // Generate command buttons
        function generateCommandButtons() {
            const container = document.getElementById('quick-commands-content');
            container.innerHTML = ''; // Clear existing buttons

            Object.entries(commands).forEach(([id, command]) => {
                const button = document.createElement('button');
                button.id = id;
                button.className = 'command-button';
                button.textContent = command.label;
                button.title = command.description;
                
                button.addEventListener('click', () => {
                    currentCommand = command.type;
                    dialog.style.display = 'flex';
                });
                
                container.appendChild(button);
            });
        }

        console.log('Script starting...'); // Initial script load

        var socket = io(); // The socket object receives updates from the controller
        
        // WebSocket event handlers
        socket.on('connect', function() { // When connection is established, log it
            console.log('WebSocket connection established');
            socket.emit('get_modules'); // Request initial module data
        });
    
        socket.on('disconnect', function() { // When connection is closed, log it
            console.log('WebSocket connection closed');
        });
        
        socket.on('module_update', function(data) { // When module update is received, log it and update the module list
            console.log('Received module update:', data);
            updateModuleList(data.modules);
            updateDashboardOverview(data.modules);
        });
        
        socket.on('ptp_status', function(data) { // When PTP status is received, log it and update the PTP chart
            console.log('Received PTP update:', data);
            updatePTPChart(data);
        });
        
        socket.on('error', function(error) { // When an error occurs, log it
            console.error('WebSocket error:', error);
        });

        socket.on('module_status', function(data) {
            console.log('Received module status:', data);
            displayModuleStatus(data);
        });

        function displayModuleStatus(data) {
            const statusContent = document.getElementById('status-content');
            const timestamp = new Date(data.status.timestamp * 1000).toLocaleString();
            
            // Create or update the status card for this module
            let statusCard = document.getElementById(`status-card-${data.module_id}`);
            if (!statusCard) {
                statusCard = document.createElement('div');
                statusCard.id = `status-card-${data.module_id}`;
                statusCard.className = 'status-card';
                statusContent.appendChild(statusCard);
            }
            
            const statusHTML = `
                <div class="status-header">
                    <h3>${data.module_id}</h3>
                    <span class="status-timestamp">${timestamp}</span>
                </div>
                <div class="status-grid">
                    <div class="status-item">
                        <span class="status-label">CPU Temperature</span>
                        <span class="status-value">${data.status.cpu_temp}Â°C</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">CPU Usage</span>
                        <span class="status-value">${data.status.cpu_usage}%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Memory Usage</span>
                        <span class="status-value">${data.status.memory_usage}%</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Uptime</span>
                        <span class="status-value">${formatUptime(data.status.uptime)}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Disk Space</span>
                        <span class="status-value">${data.status.disk_space}%</span>
                    </div>
                    ${data.status.ptp4l_offset !== null ? `
                        <div class="status-item">
                            <span class="status-label">PTP4L Offset</span>
                            <span class="status-value">${data.status.ptp4l_offset}ns</span>
                        </div>
                    ` : ''}
                    ${data.status.ptp4l_freq !== null ? `
                        <div class="status-item">
                            <span class="status-label">PTP4L Frequency</span>
                            <span class="status-value">${data.status.ptp4l_freq}ppb</span>
                        </div>
                    ` : ''}
                    ${data.status.phc2sys_offset !== null ? `
                        <div class="status-item">
                            <span class="status-label">PHC2SYS Offset</span>
                            <span class="status-value">${data.status.phc2sys_offset}ns</span>
                        </div>
                    ` : ''}
                    ${data.status.phc2sys_freq !== null ? `
                        <div class="status-item">
                            <span class="status-label">PHC2SYS Frequency</span>
                            <span class="status-value">${data.status.phc2sys_freq}ppb</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            statusCard.innerHTML = statusHTML;
        }

        function formatUptime(seconds) {
            if (seconds === 0) return '0s';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            
            const parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (remainingSeconds > 0) parts.push(`${remainingSeconds}s`);
            
            return parts.join(' ');
        }

        // Module selection dialog
        const dialog = document.getElementById('module-selection-dialog');
        const moduleOptions = document.getElementById('module-options');
        const closeButton = document.querySelector('.dialog-close');
        let currentCommand = null;

        // Command Button Event Listeners
        closeButton.addEventListener('click', () => {
            dialog.style.display = 'none';
            currentCommand = null;
        });

        // Update the module selection dialog options
        function updateModuleOptions(modules) {
            moduleOptions.innerHTML = '';
            modules.forEach(module => {
                const button = document.createElement('button');
                button.className = 'dialog-option';
                button.textContent = `${module.type} (${module.id})`;
                button.dataset.moduleId = module.id;
                button.addEventListener('click', () => {
                    sendCommand(module.id);
                    dialog.style.display = 'none';
                });
                moduleOptions.appendChild(button);
            });
        }

        // Send command to module
        function sendCommand(moduleId) {
            if (!currentCommand) {
                console.error('No command selected');
                return;
            }

            const command = {
                type: currentCommand,
                module_id: moduleId
            };
            console.log('Sending command:', command);
            socket.emit('command', command);
            currentCommand = null;
        }

        // Add click handler for "All Modules" option
        document.querySelector('[data-module="all"]').addEventListener('click', () => {
            sendCommand('all');
            dialog.style.display = 'none';
        });

        // Update the module list
        function updateModuleList(modules) {
            console.log('updateModuleList called with:', modules);
            const moduleList = document.getElementById('modules');
            if (!moduleList) {
                console.error('Could not find modules element');
                return;
            }
            moduleList.innerHTML = '';
            
            if (!modules || modules.length === 0) {
                console.log('No modules to display');
                moduleList.innerHTML = '<p>No modules found</p>';
                return;
            }
            
            // Get list of active module IDs for cleanup
            const activeModuleIds = modules.map(module => module.id);
            
            modules.forEach(module => {
                console.log('Creating module element for:', module);
                const moduleElement = document.createElement('module-item');
                moduleElement.setAttribute('module-id', module.id);
                moduleElement.setAttribute('module-type', module.type);
                moduleElement.setAttribute('module-ip', module.ip);
                moduleList.appendChild(moduleElement);
            });

            // Update the module selection dialog options
            updateModuleOptions(modules);
            
            // Clean up status cards for disconnected modules
            cleanupDisconnectedModules(activeModuleIds);
        }

        // Add cleanup for disconnected modules
        function cleanupDisconnectedModules(activeModules) {
            const statusContent = document.getElementById('status-content');
            const statusCards = statusContent.getElementsByClassName('status-card');
            
            // Convert HTMLCollection to Array for easier manipulation
            Array.from(statusCards).forEach(card => {
                const moduleId = card.id.replace('status-card-', '');
                if (!activeModules.includes(moduleId)) {
                    card.remove();
                }
            });
        }

        // Update the dashboard overview
        function updateDashboardOverview(modules) {
            console.log('updateDashboardOverview called with:', modules);
            const numberOfModules = document.getElementById('number-of-modules');
            if (!numberOfModules) {
                console.error('Could not find number-of-modules element');
                return;
            }
            numberOfModules.textContent = modules ? modules.length : 0;

            // Debug logging for module types
            if (modules) {
                console.log('All module types:', modules.map(m => m.type));
                console.log('Camera modules:', modules.filter(module => module.type === 'camera'));
                console.log('TTL modules:', modules.filter(module => module.type === 'ttl'));
            }

            const numberOfCameraModules = document.getElementById('number-of-camera-modules');
            if (!numberOfCameraModules) {
                console.error('Could not find number-of-camera-modules element');
                return;
            }
            numberOfCameraModules.textContent = modules ? modules.filter(module => module.type === 'camera').length : 0; // Update the number of camera modules in the dashboard overview
            const numberOfTTLModules = document.getElementById('number-of-ttl-modules');  
            if (!numberOfTTLModules) {
                console.error('Could not find number-of-ttl-modules element');
                return;
            }
            numberOfTTLModules.textContent = modules ? modules.filter(module => module.type === 'ttl').length : 0; // Update the number of TTL modules in the dashboard overview
        }   

        function updatePTPChart(data) {
            console.log('PTP data:', data);
            // TODO: Implement PTP chart update
        }

        // Initialize command buttons
        generateCommandButtons();

        // Log when the page is fully loaded
        window.addEventListener('load', function() {
            console.log('Page fully loaded');
        });
    </script>
</body>
</html> 
